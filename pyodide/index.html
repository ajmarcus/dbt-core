<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/js/jquery.terminal.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.23.0/css/jquery.terminal.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/sql/sql.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/dracula.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.19.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">
    <style>
      .terminal {
        --size: 1.5;
        --background-color: rgba(255, 255, 255, 0.8);
      }
      body {
        background-color: rgb(30, 30, 30);
        color: white;
        font-family: monospace;
      }
      button {
        color: black;
        background-color: darkorchid;
        font-size: 0.8rem;
        border: 0;
        padding: 0.6rem 0.9rem;
        margin-right: 0.2rem;
        margin-top: 0.4rem;
      }
      button:hover {
        background-color: orchid;
      }
      #editor {
        display: grid;
        grid-gap: 0px;
        grid-template-columns: 190px 650px 610px;
        /* grid-template-columns: 2fr 7fr 5fr; */
        grid-template-rows: 15px 25px 500px 48px 260px;
      }
      #header {
        background-color: rgb(40, 40, 40);
        grid-row: 1 / 1;
        grid-column: 1 / 4;
        padding-top: 0.1rem;
        padding-left: 0.5rem;
        font-size: 0.6rem;
      }
      #sidebar {
        background-color: rgb(25, 25, 25);
        grid-row: 2 / 6;
        grid-column: 1 / 1;
        overflow: auto;
      }
      #sidebar-list {
        list-style-type: none;
        padding: 0.5rem;
        margin: 0.5rem;
      }
      #sidebar-list > li {
        padding-top: 0.3rem;
      }
      #file-filename {
        background-color: rgb(30, 30, 30);
        grid-row: 2 / 2;
        grid-column: 2 / 2;
        padding-top: 0.3rem;
        padding-left: 0.5rem;
        font-size: 0.8rem;
      }
      #file {
        background-color: rgb(15, 15, 15);
        grid-row: 3 / 3;
        grid-column: 2 / 2;
        padding: 0;
        font-size: 1.2rem;
      }
      .CodeMirror {
        height: 97%;
        padding: 0.5rem;
      }
      #result-filename {
        background-color: rgb(30, 30, 30);
        grid-row: 2 / 2;
        grid-column: 3 / 3;
        padding-top: 0.3rem;
        padding-left: 0.5rem;
        font-size: 0.8rem;
      }
      #result {
        background-color: rgb(25, 25, 25);
        grid-row: 3 / 3;
        grid-column: 3 / 3;
        overflow: auto;
        padding: 1rem;
        font-size: 1.2rem;
      }
      #command-bar {
        background-color: rgb(25, 25, 25);
        grid-row: 4 / 4;
        grid-column: 2 / 4;
      }
      #terminal-container {
        background-color: black;
        grid-row: 5 / 5;
        grid-column: 2 / 4;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div id="editor">
      <div id="header">dbowser</div>
      <div id="sidebar"><ul id="sidebar-list"></ul></div>
      <div id="file-filename"></div>
      <div id="file"></div>
      <div id="result-filename"></div>
      <div id="result"></div>
      <div id="command-bar">
        <button id="command-save">Save</button>
        <button id="command-preview">Preview</button>
        <button id="command-run">Run</button>
        <button id="command-test">Test</button>
      </div>
      <div id="terminal-container"></div>
    </div>
    <script>
      "use strict";
      function sleep(s) {
        return new Promise((resolve) => setTimeout(resolve, s));
      }

      async function main() {
        globalThis.pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.19.1/full/",
        });
        let namespace = pyodide.globals.get("dict")();
        pyodide.runPython(
          `
            import sys
            from pyodide import to_js
            from pyodide.console import PyodideConsole, repr_shorten, BANNER
            import __main__
            BANNER = "Welcome to your dbt terminal emulator ðŸ’œðŸ’œðŸ’œ\\n" + BANNER
            pyconsole = PyodideConsole(__main__.__dict__)
            import builtins
            async def await_fut(fut):
              res = await fut
              if res is not None:
                builtins._ = res
              return to_js([res], depth=1)
            def clear_console():
              pyconsole.buffer = []
        `,
          namespace
        );
        let repr_shorten = namespace.get("repr_shorten");
        let banner = namespace.get("BANNER");
        let await_fut = namespace.get("await_fut");
        let pyconsole = namespace.get("pyconsole");
        let clear_console = namespace.get("clear_console");
        namespace.destroy();

        let ps1 = ">>> ",
          ps2 = "... ";

        async function lock() {
          let resolve;
          let ready = term.ready;
          term.ready = new Promise((res) => (resolve = res));
          await ready;
          return resolve;
        }

        async function interpreter(command) {
          let unlock = await lock();
          term.pause();
          // multiline should be splitted (useful when pasting)
          for (const c of command.split("\n")) {
            let fut = pyconsole.push(c);
            term.set_prompt(fut.syntax_check === "incomplete" ? ps2 : ps1);
            switch (fut.syntax_check) {
              case "syntax-error":
                term.error(fut.formatted_error.trimEnd());
                continue;
              case "incomplete":
                continue;
              case "complete":
                break;
              default:
                throw new Error(`Unexpected type ${ty}`);
            }
            // In JavaScript, await automatically also awaits any results of
            // awaits, so if an async function returns a future, it will await
            // the inner future too. This is not what we want so we
            // temporarily put it into a list to protect it.
            let wrapped = await_fut(fut);
            // complete case, get result / error and print it.
            try {
              let [value] = await wrapped;
              if (value !== undefined) {
                term.echo(
                  repr_shorten.callKwargs(value, {
                    separator: "\n[[;orange;]<long output truncated>]\n",
                  })
                );
              }
              if (pyodide.isPyProxy(value)) {
                value.destroy();
              }
            } catch (e) {
              if (e.constructor.name === "PythonError") {
                const message = fut.formatted_error || e.message;
                term.error(message.trimEnd());
              } else {
                throw e;
              }
            } finally {
              fut.destroy();
              wrapped.destroy();
            }
          }
          term.resume();
          await sleep(10);
          unlock();
        }

        function catFile(filename) {
          let prefix = "/home/pyodide/bowser/";
          let command = `file_cat("${prefix}${filename}")`
          return pyodide.runPython(command).toJs();
        }

        function saveFile(filename, value) {
          let prefix = "/home/pyodide/bowser/";
          let sanitized = value.split("\"").join("\\\"");
          let command = `file_write("${prefix}${filename}", """${sanitized}""")`
          pyodide.runPython(command);
        }

        function queryFile(filename) {
          let prefix = "/home/pyodide/bowser/";
          pyodide.runPython(`query("${prefix}${filename}")`)
        }

        function compiledFilename(filename) {
          return `target/compiled/bowser/${filename}`;
        }

        function isModel(filename) {
          return filename.startsWith("models") && filename.endsWith("sql");
        }

        function compileModel(filename) {
          let modelname = filename.split("/").pop().split(".")[0];
          pyodide.runPython(`tdb("compile -m ${modelname}")`);
          return catFile(compiledFilename(filename));
        }

        function runModel(filename) {
          let modelname = filename.split("/").pop().split(".")[0];
          pyodide.runPython(`tdb("run -m +${modelname}")`);
        }

        function testModel(filename) {
          let modelname = filename.split("/").pop().split(".")[0];
          pyodide.runPython(`tdb("test -m +${modelname}")`);
        }

        function setResult(filename) {
          $.when(
            $.map(
              compileModel(filename),
              function(item) { $("#result").append(item + "<br/>") }
            )
          ).done(
            $("#result-filename")
              .text(compiledFilename(filename))
              .css("background-color", "darkgreen")
          );
        }

        function loadFiles(editor) {
          $.when( $("#sidebar-list").empty() )
          .then(
            $.map(
              pyodide.runPython("file_list('/home/pyodide/bowser/')").toJs(),
              function(item) { $("#sidebar-list").append("<li>"+item+"</li>") }
            )
          ).done(
            $("#sidebar-list > li").click(function() {
              let filename = $( this ).text();
              saveCurrentFile(editor);
              refresh(editor, filename);
            })
          );
        }

        function refresh(editor, filename) {
          editor.getDoc().setValue(catFile(filename).join("\n"));
          $("#file-filename").text(filename);
          $("#result-filename").empty().css("background-color", "rgb(30, 30, 30)");
          $("#result").empty();
          if (isModel(filename)) {
            setResult(filename);
          }
          loadFiles(editor);
        }

        function save(filename, value) {
          saveFile(filename, value);
          $("#result-filename").empty().css("background-color", "rgb(30, 30, 30)");
          $("#result").empty();
          if (filename.startsWith("models") && filename.endsWith("sql")) {
            setResult(filename);
          }
        }

        function saveCurrentFile(editor) {
          let filename = $("#file-filename").text();
          save(filename, editor.getDoc().getValue());
          loadFiles(editor);
          return filename;
        }

        function preview(editor) {
          let filename = saveCurrentFile(editor);
          if (isModel(filename)) {
            compileModel(filename); // ensure model is compiled
            queryFile(compiledFilename(filename));
            loadFiles(editor);
          }
        }

        function run(editor) {
          let filename = saveCurrentFile(editor);
          if (isModel(filename)) {
            runModel(filename);
            loadFiles(editor);
          }
        }

        function test(editor) {
          let filename = saveCurrentFile(editor);
          if (isModel(filename)) {
            runModel(filename);
            testModel(filename);
            loadFiles(editor);
          }
        }

        let term = $("#terminal-container").terminal(interpreter, {
          greetings: banner,
          prompt: ps1,
          height: 260,
          completionEscape: false,
          completion: function (command, callback) {
            callback(pyconsole.complete(command).toJs()[0]);
          },
          keymap: {
            "CTRL+C": async function (event, original) {
              clear_console();
              term.echo_command();
              term.echo("KeyboardInterrupt");
              term.set_command("");
              term.set_prompt(ps1);
            },
            TAB: (event, original) => {
              const command = term.before_cursor();
              // Disable completion for whitespaces.
              if (command.trim() === "") {
                term.insert("\t");
                return false;
              }
              return original(event);
            },
          },
        });
        window.term = term;
        pyconsole.stdout_callback = (s) => term.echo(s, { newline: false });
        pyconsole.stderr_callback = (s) => {
          term.error(s.trimEnd());
        };
        term.ready = Promise.resolve();
        pyodide._module.on_fatal = async (e) => {
          term.error(
            "Pyodide has suffered a fatal error. Please report this to the Pyodide maintainers."
          );
          term.error("The cause of the fatal error was:");
          term.error(e);
          term.error("Look in the browser console for more details.");
          await term.ready;
          term.pause();
          await sleep(15);
          term.pause();
        };
        var editor = CodeMirror(
          document.getElementById("file"),
          {
            value: "Loading....",
            mode:  "sql",
            theme: "dracula",
          }
        );
        $("#command-save").click(function(){
          saveCurrentFile(editor);
        });
        $("#command-preview").click(function(){
          preview(editor)
        });
        $("#command-run").click(function(){
          run(editor)
        });
        $("#command-test").click(function(){
          test(editor)
        });
        // capture keypress for save preview run & test
        $(document).on({
          keydown: function(event) {
            // cmd+s, ctrl+s
            if ((event.ctrlKey || event.metaKey) & event.which === 83) {
              event.preventDefault();
              saveCurrentFile(editor)
            }
            // cmd+p, ctrl+p
            if ((event.ctrlKey || event.metaKey) & event.which === 80) {
              event.preventDefault();
              preview(editor)
            }
            // cmd+r, ctrl+r
            if ((event.ctrlKey || event.metaKey) & event.which === 82) {
              event.preventDefault();
              run(editor)
            }
            // cmd+t, ctrl+t - not working
            if ((event.ctrlKey || event.metaKey) & event.which === 84) {
              event.preventDefault();
              test(editor)
            }
          }
        });
        $.when(
          interpreter(
            `
            import micropip
            import sqlite3
            from typing import List
            import os
            import json
            import logging

            STDOUT = logging.getLogger('default_stdout')

            deps = [
                "https://storage.googleapis.com/db-owser/parsedatetime-2.7-py3-none-any.whl",
                "https://storage.googleapis.com/db-owser/minimal-snowplow-tracker-0.0.2-py3-none-any.whl",
                "https://storage.googleapis.com/db-owser/dbt_core-1.0.1.4-py3-none-any.whl",
                "https://storage.googleapis.com/db-owser/dbt_sqlite-1.0.0-py3-none-any.whl",
            ]
            for d in deps:
                await micropip.install(d, True)
            
            import dbt.main

            def tdb(cmd: str = None):
                if cmd is None:
                    return dbt.main.main([])
                else:
                    return dbt.main.main(cmd.split(" "))

            def cat(filename: str) -> None:
                f = open(filename)
                for line in f:
                    STDOUT.info(line)
                
            def ls(root_dir: str) -> None:
                for root, dirs, files in os.walk(root_dir):
                    for filename in files:
                        STDOUT.info(f"{root}/{filename}")
            
            def file_list(root_dir: str) -> List[str]:
                result = []
                for root, dirs, files in os.walk(root_dir):
                    for filename in files:
                        relative = root[len(root_dir):]
                        if len(relative) > 0:
                            result.append(f"{relative}/{filename}")
                        else:
                            result.append(filename)
                return result

            def file_cat(filename: str) -> List[str]:
                result = []
                f = open(filename)
                for line in f:
                    result.append(line.strip())
                return result

            def file_write(filename: str, value: str) -> None:
                f = open(filename, "w")
                f.write(value)
                f.close()

            class DB(object):
                def __init__(self, filename: str) -> None:
                    self._con = sqlite3.connect(filename)
                
            def select(db: DB, query: str) -> None:
                cur = db._con.cursor()
                STDOUT.info("Query results:")
                STDOUT.info("===========================")
                for row in cur.execute(query):
                    STDOUT.info(row)
                STDOUT.info("===========================")

            def tables(db: DB) -> None:
                return select(db, "select * from sqlite_master")
            
            def query(filename: str) -> None:
                db = DB("./dev.db")
                sql = open(filename).read().rstrip()
                if sql.endswith(";"):
                  sql = sql[:len(sql)-1]
                sql += " limit 50;"
                select(db, sql)

            tdb("init")
            os.chdir("../bowser/")
            # tdb("compile")
            `
          )
        ).done( function() {
          refresh(editor, "models/example/my_second_dbt_model.sql");
        })
      }
      window.console_ready = main();
    </script>
  </body>
</html>
